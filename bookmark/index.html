<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBL Toolkit Â· ë¶ë§ˆí¬ (Cloud Sync)</title>
    <style>
        /* [ì›ë³¸ ë””ìì¸ ìœ ì§€] */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-primary: #ffffff; --bg-secondary: #f5f5f5; --bg-card: #ffffff;
            --text-primary: #1a1a1a; --text-secondary: #666666; --border-color: #e0e0e0;
            --accent-color: #4a90e2; --hover-color: #f8f9fa; --shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        [data-theme="dark"] {
            --bg-primary: #1a1a1a; --bg-secondary: #2d2d2d; --bg-card: #2d2d2d;
            --text-primary: #e0e0e0; --text-secondary: #a0a0a0; --border-color: #404040;
            --accent-color: #5ba3f5; --hover-color: #3a3a3a; --shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg-primary); color: var(--text-primary); transition: 0.3s; padding: 20px; min-height: 100vh; }
        .header { max-width: 1400px; margin: 0 auto 30px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .header h1 { font-size: 28px; font-weight: 700; }
        .header-controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .search-box input { padding: 10px 15px; border: 2px solid var(--border-color); border-radius: 8px; background: var(--bg-card); color: var(--text-primary); width: 200px; }
        .btn { padding: 10px 15px; border: none; border-radius: 8px; background: var(--accent-color); color: white; font-weight: 600; cursor: pointer; transition: 0.3s; font-size: 14px; }
        .btn-secondary { background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); }
        .theme-toggle { background: var(--bg-card); border: 2px solid var(--border-color); padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 18px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .category { margin-bottom: 40px; }
        .category-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px 20px; background: var(--bg-secondary); border-radius: 12px; cursor: pointer; }
        .category-title { display: flex; align-items: center; gap: 10px; font-size: 20px; font-weight: 600; }
        .category-count { background: var(--accent-color); color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; }
        .bookmarks-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .bookmark-card { background: var(--bg-card); border: 2px solid var(--border-color); border-radius: 12px; padding: 20px; display: flex; flex-direction: column; gap: 12px; transition: 0.3s; cursor: pointer; position: relative; }
        .bookmark-card:hover { transform: translateY(-4px); box-shadow: var(--shadow); border-color: var(--accent-color); }
        .bookmark-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; background: var(--bg-secondary); font-size: 24px; }
        .bookmark-icon img { width: 32px; height: 32px; }
        .bookmark-title { font-size: 16px; font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .bookmark-url { font-size: 12px; color: var(--text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .bookmark-actions { position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; opacity: 0; transition: 0.3s; }
        .bookmark-card:hover .bookmark-actions { opacity: 1; }
        .action-btn { width: 28px; height: 28px; border-radius: 6px; border: none; background: var(--bg-secondary); color: var(--text-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .add-bookmark-card { background: var(--bg-secondary); border: 2px dashed var(--border-color); border-radius: 12px; padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; min-height: 180px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: var(--bg-card); border-radius: 16px; padding: 30px; max-width: 500px; width: 90%; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; background: var(--bg-primary); color: var(--text-primary); }
        #main-content { display: none; }
    </style>
</head>
<body>

    <div id="main-content">
        <div class="header">
            <h1>ğŸ“š ë¶ë§ˆí¬</h1>
            <div class="header-controls">
                <button class="btn btn-secondary" onclick="location.href='../index.html'">ğŸ  í™ˆ</button>
                <div class="search-box"><input type="text" id="searchInput" placeholder="ê²€ìƒ‰..."></div>
                <button class="btn" onclick="openAddBookmarkModal()">+ ë¶ë§ˆí¬</button>
                <button class="btn btn-secondary" onclick="openAddCategoryModal()">+ ì¹´í…Œê³ ë¦¬</button>
                <button class="btn btn-secondary" onclick="exportToJSON()">ğŸ’¾ ë‚´ë³´ë‚´ê¸°</button>
                <button class="btn btn-secondary" onclick="triggerImport()">ğŸ“¥ ê°€ì ¸ì˜¤ê¸°</button>
                <button class="theme-toggle" onclick="toggleTheme()">ğŸŒ“</button>
            </div>
        </div>
        <div class="container" id="categoriesContainer"></div>
    </div>

    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleImport(event)">

    <div class="modal" id="bookmarkModal" onclick="if(event.target===this) closeBookmarkModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div id="modalTitle" style="font-size:20px; font-weight:700; margin-bottom:20px;">ë¶ë§ˆí¬ ì„¤ì •</div>
            <div class="form-group"><label>ì œëª©</label><input type="text" id="bookmarkTitle" placeholder="ì…ë ¥ ì‹œ ìë™ ì €ì¥"></div>
            <div class="form-group"><label>URL</label><input type="url" id="bookmarkUrl" placeholder="ì…ë ¥ ì‹œ ìë™ ì €ì¥"></div>
            <div class="form-group"><label>ì¹´í…Œê³ ë¦¬</label><select id="bookmarkCategory"></select></div>
            <div style="text-align:right; font-size:12px; color:var(--text-secondary);">ì°½ì„ ë‹«ìœ¼ë©´ ì‹¤ì‹œê°„ ì €ì¥ë©ë‹ˆë‹¤.</div>
        </div>
    </div>

    <div class="modal" id="categoryModal" onclick="if(event.target===this) closeCategoryModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div style="font-size:20px; font-weight:700; margin-bottom:20px;">ì¹´í…Œê³ ë¦¬ ì„¤ì •</div>
            <div class="form-group"><label>ì´ë¦„</label><input type="text" id="categoryName" placeholder="ì…ë ¥ ì‹œ ìë™ ì €ì¥"></div>
            <div class="form-group"><label>ì•„ì´ì½˜ (ì´ëª¨ì§€)</label><input type="text" id="categoryIcon" maxlength="2" placeholder="ì…ë ¥ ì‹œ ìë™ ì €ì¥"></div>
            <div style="text-align:right; font-size:12px; color:var(--text-secondary);">ì°½ì„ ë‹«ìœ¼ë©´ ì‹¤ì‹œê°„ ì €ì¥ë©ë‹ˆë‹¤.</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAd08tVXgWZ2_dg3jzvhawmH4jtolRmfhY",
            authDomain: "itnews-82b60.firebaseapp.com",
            databaseURL: "https://itnews-82b60-default-rtdb.firebaseio.com",
            projectId: "itnews-82b60",
            storageBucket: "itnews-82b60.firebasestorage.app",
            messagingSenderId: "719267588761",
            appId: "1:719267588761:web:3c4607cb799620f9446608"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const ALLOWED = "eundang@gmail.com";

        let currentUserId = null;
        let categories = [];
        let bookmarks = [];
        let editingBookmarkId = null;
        let editingCategoryId = null;

        onAuthStateChanged(auth, (user) => {
            if (user && user.email.toLowerCase() === ALLOWED) {
                currentUserId = user.uid;
                document.getElementById('main-content').style.display = 'block';
                loadCloudData();
            } else {
                alert("ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
                location.href = "../index.html";
            }
        });

        function loadCloudData() {
            onValue(ref(db, `users/${currentUserId}/bookmarksData`), (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    categories = data.categories || [];
                    bookmarks = data.bookmarks || [];
                } else {
                    categories = [{ id: 'work', name: 'ì—…ë¬´', icon: 'ğŸ’¼', visible: true }];
                    bookmarks = [];
                    saveCloudData();
                }
                renderCategories();
            });
        }

        function saveCloudData() {
            if (!currentUserId) return;
            set(ref(db, `users/${currentUserId}/bookmarksData`), { categories, bookmarks });
        }

        // --- ìë™ ì €ì¥ ë¡œì§ ---
        function handleBookmarkInput() {
            const title = document.getElementById('bookmarkTitle').value.trim();
            const url = document.getElementById('bookmarkUrl').value.trim();
            const category = document.getElementById('bookmarkCategory').value;
            if (!title || !url) return;
            if (editingBookmarkId) {
                const b = bookmarks.find(x => x.id === editingBookmarkId);
                if (b) { b.title = title; b.url = url; b.category = category; }
            } else {
                const newId = 'bm_' + Date.now();
                bookmarks.push({ id: newId, title, url, category, clicks: 0 });
                editingBookmarkId = newId;
            }
            saveCloudData();
        }

        function handleCategoryInput() {
            const name = document.getElementById('categoryName').value.trim();
            const icon = document.getElementById('categoryIcon').value.trim() || 'ğŸ“';
            if (!name) return;
            if (editingCategoryId) {
                const c = categories.find(x => x.id === editingCategoryId);
                if (c) { c.name = name; c.icon = icon; }
            } else {
                const newId = 'cat_' + Date.now();
                categories.push({ id: newId, name, icon, visible: true });
                editingCategoryId = newId;
            }
            saveCloudData();
        }

        document.getElementById('bookmarkTitle').oninput = handleBookmarkInput;
        document.getElementById('bookmarkUrl').oninput = handleBookmarkInput;
        document.getElementById('bookmarkCategory').onchange = handleBookmarkInput;
        document.getElementById('categoryName').oninput = handleCategoryInput;
        document.getElementById('categoryIcon').oninput = handleCategoryInput;

        // --- ê°€ì ¸ì˜¤ê¸° / ë‚´ë³´ë‚´ê¸° ë¡œì§ ---
        window.exportToJSON = () => {
            const data = { categories, bookmarks, exportDate: new Date().toISOString() };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `sbl-bookmarks-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        };

        window.triggerImport = () => document.getElementById('importFile').click();

        window.handleImport = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (confirm("ê¸°ì¡´ í´ë¼ìš°ë“œ ë°ì´í„°ë¥¼ ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                        categories = imported.categories || [];
                        bookmarks = imported.bookmarks || [];
                        saveCloudData();
                        alert("ê°€ì ¸ì˜¤ê¸° ì„±ê³µ!");
                    }
                } catch (err) { alert("ì˜ëª»ëœ íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤."); }
            };
            reader.readAsText(file);
        };

        // --- UI ë Œë”ë§ ---
        window.renderCategories = function() {
            const container = document.getElementById('categoriesContainer');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            container.innerHTML = '';
            categories.forEach(category => {
                const catBms = bookmarks.filter(b => b.category === category.id)
                    .filter(b => !searchTerm || b.title.toLowerCase().includes(searchTerm))
                    .sort((a, b) => (b.clicks || 0) - (a.clicks || 0));
                const div = document.createElement('div');
                div.className = 'category';
                div.innerHTML = `
                    <div class="category-header" onclick="toggleCategory('${category.id}')">
                        <div class="category-title"><span>${category.icon}</span><span>${category.name}</span><span class="category-count">${catBms.length}</span></div>
                        <div style="display:flex; gap:10px;">
                            <button class="action-btn" onclick="event.stopPropagation(); editCategory('${category.id}')">âœï¸</button>
                            <button class="action-btn" onclick="event.stopPropagation(); deleteCategory('${category.id}')">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                    <div class="bookmarks-grid ${category.visible ? '' : 'hidden'}" style="${category.visible ? '' : 'display:none'}">
                        ${catBms.map(b => `<div class="bookmark-card" onclick="openBookmark('${b.id}')">
                            <div class="bookmark-actions">
                                <button class="action-btn" onclick="event.stopPropagation(); editBookmark('${b.id}')">âœï¸</button>
                                <button class="action-btn" onclick="event.stopPropagation(); deleteBookmark('${b.id}')">ğŸ—‘ï¸</button>
                            </div>
                            <div class="bookmark-icon"><img src="https://www.google.com/s2/favicons?domain=${new URL(b.url).origin}&sz=128" onerror="this.style.display='none'"></div>
                            <div class="bookmark-title">${b.title}</div>
                            <div class="bookmark-url">${b.url}</div>
                        </div>`).join('')}
                        <div class="add-bookmark-card" onclick="openAddBookmarkModal('${category.id}')"><div style="font-size:40px">+</div><div>ë¶ë§ˆí¬ ì¶”ê°€</div></div>
                    </div>`;
                container.appendChild(div);
            });
        }

        window.openBookmark = (id) => { const b = bookmarks.find(x => x.id === id); b.clicks = (b.clicks || 0) + 1; saveCloudData(); window.open(b.url, '_blank'); };
        window.deleteCategory = (id) => { if(confirm('ì „ë¶€ ì‚­ì œí• ê¹Œìš”?')) { categories = categories.filter(c => c.id !== id); bookmarks = bookmarks.filter(b => b.category !== id); saveCloudData(); } };
        window.deleteBookmark = (id) => { if(confirm('ì‚­ì œí• ê¹Œìš”?')) { bookmarks = bookmarks.filter(b => b.id !== id); saveCloudData(); } };
        window.toggleCategory = (id) => { const c = categories.find(x => x.id === id); c.visible = !c.visible; saveCloudData(); };
        window.toggleTheme = () => { const t = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'; document.documentElement.setAttribute('data-theme', t); localStorage.setItem('theme', t); };
        
        window.openAddBookmarkModal = (catId) => { editingBookmarkId = null; document.getElementById('bookmarkTitle').value = ''; document.getElementById('bookmarkUrl').value = ''; document.getElementById('bookmarkCategory').innerHTML = categories.map(c => `<option value="${c.id}" ${catId===c.id?'selected':''}>${c.icon} ${c.name}</option>`).join(''); document.getElementById('bookmarkModal').classList.add('active'); };
        window.editBookmark = (id) => { const b = bookmarks.find(x => x.id === id); editingBookmarkId = id; document.getElementById('bookmarkTitle').value = b.title; document.getElementById('bookmarkUrl').value = b.url; document.getElementById('bookmarkCategory').innerHTML = categories.map(c => `<option value="${c.id}" ${b.category===c.id?'selected':''}>${c.icon} ${c.name}</option>`).join(''); document.getElementById('bookmarkModal').classList.add('active'); };
        window.editCategory = (id) => { const c = categories.find(x => x.id === id); editingCategoryId = id; document.getElementById('categoryName').value = c.name; document.getElementById('categoryIcon').value = c.icon; document.getElementById('categoryModal').classList.add('active'); };
        window.openAddCategoryModal = () => { editingCategoryId = null; document.getElementById('categoryName').value = ''; document.getElementById('categoryIcon').value = ''; document.getElementById('categoryModal').classList.add('active'); };
        window.closeBookmarkModal = () => document.getElementById('bookmarkModal').classList.remove('active');
        window.closeCategoryModal = () => document.getElementById('categoryModal').classList.remove('active');
        document.getElementById('searchInput').oninput = () => renderCategories();

        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
    </script>
</body>
</html>
