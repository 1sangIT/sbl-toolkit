<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë¹…ìŠ¤í†¤ - ëª©í‘œ ê´€ë¦¬</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        /* [ë ˆì´ì•„ì›ƒ í•µì‹¬] í™”ë©´ ì „ì²´ë¥¼ ê³ ì •í•˜ê³  ë‚´ë¶€ì—ì„œ ìŠ¤í¬ë¡¤ */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: #f5f5f5; color: #202124; 
            height: 100vh; /* í™”ë©´ ê½‰ ì±„ìš°ê¸° */
            overflow: hidden; /* ì „ì²´ ìŠ¤í¬ë¡¤ ë°©ì§€ */
            display: flex;
            flex-direction: column;
        }

        .container { 
            width: 100%; 
            max-width: 1400px; 
            margin: 0 auto; 
            height: 100%; 
            display: flex; 
            flex-direction: column; 
            padding: 10px;
        }
        
        /* í—¤ë”: ê³ ì • ì˜ì—­ */
        header { 
            background: white; 
            padding: 10px 15px; 
            border-radius: 8px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
            flex-shrink: 0; /* ì ˆëŒ€ ì¤„ì–´ë“¤ì§€ ì•ŠìŒ */
            z-index: 100;
        }

        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .title-area { display: flex; align-items: center; gap: 8px; }
        h1 { font-size: 18px; font-weight: 700; color: #202124; white-space: nowrap; }
        
        /* ì—°ë„ ì„ íƒ ì»¨íŠ¸ë¡¤ */
        .year-control { display: flex; align-items: center; gap: 4px; }
        #yearSelect {
            padding: 4px 2px; font-size: 15px; font-weight: bold; color: #1a73e8;
            border: 1px solid #dadce0; border-radius: 4px; background: white; cursor: pointer;
        }
        .btn-add-year {
            background: #e8f0fe; color: #1a73e8; border: none; border-radius: 4px;
            width: 24px; height: 24px; font-size: 16px; font-weight: bold; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-add-year:hover { background: #d2e3fc; }

        .buttons { display: flex; gap: 6px; }
        button { padding: 6px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; transition: background 0.2s; white-space: nowrap; }
        
        .btn-home { background: #fff; border: 1px solid #dadce0; color: #202124; font-weight: 700; }
        .btn-home:hover { background: #f1f3f4; }
        .btn-secondary { background: #f1f3f4; color: #202124; }
        .btn-secondary:hover { background: #e8eaed; }

        .tabs { display: flex; gap: 10px; border-bottom: 1px solid #e0e0e0; }
        .tab { padding: 6px 12px; border: none; background: none; cursor: pointer; font-size: 14px; color: #5f6368; border-bottom: 2px solid transparent; font-weight: 600; }
        .tab.active { color: #1a73e8; border-bottom-color: #1a73e8; }

        /* [ì½˜í…ì¸  ì˜ì—­] ë‚¨ì€ ê³µê°„ì„ ê½‰ ì±„ìš°ê³  ë‚´ë¶€ì—ì„œ ìŠ¤í¬ë¡¤ */
        .view-content { 
            flex: 1; /* ë‚¨ì€ ë†’ì´ ëª¨ë‘ ì°¨ì§€ */
            overflow-y: auto; /* ë‚´ìš© ë„˜ì¹˜ë©´ ìŠ¤í¬ë¡¤ */
            display: none; 
            padding: 10px 0 20px 0; /* í•˜ë‹¨ ì—¬ë°± í™•ë³´ */
        }
        .view-content.active { display: block; }

        /* === ë§Œë‹¤ë¼íŠ¸ ìŠ¤íƒ€ì¼ (ë°˜ì‘í˜• ìµœì í™”) === */
        /* ì»¨í…Œì´ë„ˆëŠ” í™”ë©´ ì¤‘ì•™ ì •ë ¬ */
        .mandalart-container { 
            height: 100%; 
            display: flex !important; /* flex ê°•ì œ */
            flex-direction: column;
            align-items: center; 
            justify-content: center;
            overflow: hidden; /* ê·¸ë¦¬ë“œ ë°–ìœ¼ë¡œ ë‚˜ê°€ëŠ” ê²ƒ ë°©ì§€ */
        }
        
        .mandalart-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            grid-template-rows: repeat(3, 1fr); 
            
            /* [ë°˜ì‘í˜• í•µì‹¬ ë¡œì§] */
            width: 100%;
            /* ê°€ë¡œê°€ ë„“ì€ PCì—ì„œëŠ” ë†’ì´ì— ë§ì¶¤ (í—¤ë” ì œì™¸ ë†’ì´ - ì—¬ë°±) */
            max-width: calc(100vh - 130px); 
            /* ëª¨ë°”ì¼ì—ì„œëŠ” ê°€ë¡œí­ì— ë§ì¶¤ */
            aspect-ratio: 1 / 1; 
            
            gap: 4px; 
            padding: 4px; 
            background-color: #333; /* ì „ì²´ ì™¸ê³½ì„  */
            border-radius: 4px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        /* 3x3 ì„œë¸Œ ê·¸ë¦¬ë“œ */
        .sub-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            grid-template-rows: repeat(3, 1fr); 
            gap: 1px; 
            padding: 1px;
            background-color: #fff;
            border: 2px solid #555; /* êµ¬ì—­ êµ¬ë¶„ì„  êµµê²Œ */
        }
        /* ì¤‘ì•™ í•µì‹¬ ê·¸ë¦¬ë“œ ê°•ì¡° */
        .sub-grid-center { border: 3px solid #000; z-index: 10; }

        .grid-cell { 
            width: 100%; height: 100%; 
            padding: 2px; border: 1px solid #eee; border-radius: 0; 
            resize: none; font-size: 0.8rem; text-align: center; 
            display: flex; align-items: center; justify-content: center; 
            word-break: keep-all; line-height: 1.2; font-weight: 500;
        }
        .grid-cell:focus { outline: 2px solid #1a73e8; z-index: 5; }

        /* ìƒ‰ìƒ í…Œë§ˆ (ëª…í™•í•œ êµ¬ë¶„) */
        .sub-grid-0 { background-color: #ffebee; } .sub-grid-0 .grid-cell { background-color: #ffebee; }
        .sub-grid-1 { background-color: #fff3e0; } .sub-grid-1 .grid-cell { background-color: #fff3e0; }
        .sub-grid-2 { background-color: #fffde7; } .sub-grid-2 .grid-cell { background-color: #fffde7; }
        .sub-grid-3 { background-color: #f3e5f5; } .sub-grid-3 .grid-cell { background-color: #f3e5f5; }
        .sub-grid-center { background-color: #eceff1; } .sub-grid-center .grid-cell { background-color: #eceff1; }
        .sub-grid-5 { background-color: #e3f2fd; } .sub-grid-5 .grid-cell { background-color: #e3f2fd; }
        .sub-grid-6 { background-color: #e8f5e9; } .sub-grid-6 .grid-cell { background-color: #e8f5e9; }
        .sub-grid-7 { background-color: #e0f2f1; } .sub-grid-7 .grid-cell { background-color: #e0f2f1; }
        .sub-grid-8 { background-color: #efebe9; } .sub-grid-8 .grid-cell { background-color: #efebe9; }

        .main-goal { background-color: #ffeb3b !important; font-weight: 800; font-size: 1.1rem; border: 2px solid #fbc02d; }
        .sub-goal { background-color: #fff !important; font-weight: 700; border: 1px solid #999; }

        /* === ë¹…ìŠ¤í†¤ ë·° ìŠ¤íƒ€ì¼ === */
        .year-view { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; }
        .month-card { background: white; padding: 12px; border-radius: 8px; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .month-name { font-weight: 700; text-align: center; border-bottom: 2px solid #eee; padding-bottom: 5px; margin-bottom: 5px; }
        .bigstone-preview { min-height: 50px; font-size: 11px; }
        .bigstone-category-title { font-weight: 700; color: #1a73e8; margin-top: 4px; }
        
        .month-detail { display: none; height: 100%; grid-template-columns: 1fr 1fr; gap: 15px; }
        .month-detail.active { display: grid; }
        .section { background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #eee; overflow-y: auto; }
        
        .task-item { background: #f8f9fa; padding: 8px; margin-bottom: 5px; border-radius: 4px; display: flex; align-items: center; border-left: 3px solid #1a73e8; }
        .add-task-form.active { display: block; padding: 10px; background: #eee; border-radius: 4px; margin-top: 5px; }
        .add-task-form { display: none; }
        input, textarea { width: 100%; padding: 6px; margin-bottom: 5px; border: 1px solid #ccc; border-radius: 4px; }

        @media (max-width: 768px) {
            .month-detail.active { grid-template-columns: 1fr; grid-template-rows: 1fr 1fr; }
            .mandalart-grid { max-width: 100%; margin-top: 10px; }
            h1 { font-size: 16px; }
            .grid-cell { font-size: 0.7rem; }
            .buttons span { display: none; } /* ëª¨ë°”ì¼ì—ì„œ ë²„íŠ¼ í…ìŠ¤íŠ¸ ìˆ¨ê¹€ */
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-top">
                <div class="title-area">
                    <h1>ë¹…ìŠ¤í†¤</h1>
                    <div class="year-control">
                        <select id="yearSelect" onchange="changeYear(this.value)"></select>
                        <button class="btn-add-year" onclick="addYearPrompt()" title="ì—°ë„ ì¶”ê°€">+</button>
                    </div>
                </div>
                <div class="buttons">
                    <button class="btn-home" onclick="location.href='../index.html'">ğŸ  <span>í™ˆìœ¼ë¡œ</span></button>
                    <button class="btn-secondary" onclick="exportData()">ğŸ“¤ <span>ë°±ì—…</span></button>
                    <button class="btn-secondary" onclick="document.getElementById('importFile').click()">ğŸ“¥ <span>ë³µì›</span></button>
                    <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
                </div>
            </div>
            <div class="tabs">
                <button class="tab active" onclick="switchTab('bigstone')">ë¹…ìŠ¤í†¤</button>
                <button class="tab" onclick="switchTab('mandalart')">ë§Œë‹¤ë¼íŠ¸</button>
            </div>
        </header>

        <div id="bigstoneView" class="view-content active">
            <div id="yearView" class="year-view"></div>
            <div id="monthDetail" class="month-detail">
                <div class="section">
                    <button class="btn-secondary" onclick="showYearView()" style="margin-bottom:10px;">â† ì „ì²´ ëª©ë¡</button>
                    <h3 id="monthTitle" style="margin-bottom:10px; font-weight:700"></h3>
                    <div class="category-group">
                        <h4 style="color:#555; margin:10px 0 5px;">ë‚˜ (Self)</h4>
                        <div id="bigstone-me"></div>
                        <button class="btn-secondary" onclick="showAddForm('bigstone', 'me')" style="width:100%; margin-top:5px">+ ëª©í‘œ ì¶”ê°€</button>
                        <div id="form-bigstone-me" class="add-task-form"></div>
                    </div>
                    <div class="category-group">
                        <h4 style="color:#555; margin:15px 0 5px;">ê°€ì¡± (Family)</h4>
                        <div id="bigstone-family"></div>
                        <button class="btn-secondary" onclick="showAddForm('bigstone', 'family')" style="width:100%; margin-top:5px">+ ëª©í‘œ ì¶”ê°€</button>
                        <div id="form-bigstone-family" class="add-task-form"></div>
                    </div>
                    <div class="category-group">
                        <h4 style="color:#555; margin:15px 0 5px;">ì—…ë¬´ (Work)</h4>
                        <div id="bigstone-work"></div>
                        <button class="btn-secondary" onclick="showAddForm('bigstone', 'work')" style="width:100%; margin-top:5px">+ ëª©í‘œ ì¶”ê°€</button>
                        <div id="form-bigstone-work" class="add-task-form"></div>
                    </div>
                </div>
                <div class="section">
                    <h3 style="margin-bottom:10px; font-weight:700">ì„¸ë¶€ ì‹¤í–‰ ê³„íš (To-Do)</h3>
                    <div id="todoList"></div>
                    <button class="btn-secondary" onclick="showAddForm('todo', 'general')" style="width:100%; margin-top:10px">+ í•  ì¼ ì¶”ê°€</button>
                    <div id="form-todo-general" class="add-task-form"></div>
                </div>
            </div>
        </div>

        <div id="mandalartView" class="view-content mandalart-container">
            <div id="mandalart-grid" class="mandalart-grid"></div>
        </div>
    </div>

    <script>
        const months = ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'];
        let currentYear = 2026; 
        let currentMonth = null;
        let availableYears = [2026]; // ì‚¬ìš© ê°€ëŠ¥í•œ ì—°ë„ ëª©ë¡

        let allBigstoneData = {}; 
        let allMandalartData = {}; 
        let data = { bigstones: {}, todos: {} }; 
        let currentMandalartData = {};

        function init() {
            loadAllData();
            initYearSelect();
            changeYear(currentYear);
        }

        function loadAllData() {
            const savedBig = localStorage.getItem('bigstoneYearlyData');
            const savedMan = localStorage.getItem('mandalartYearlyData');
            
            if(savedBig) {
                allBigstoneData = JSON.parse(savedBig);
                // ì €ì¥ëœ ë°ì´í„°ì—ì„œ ì—°ë„ í‚¤ë¥¼ ì¶”ì¶œí•˜ì—¬ ëª©ë¡ ì—…ë°ì´íŠ¸
                const years = Object.keys(allBigstoneData).map(Number).filter(y => !isNaN(y));
                if (years.length > 0) {
                    availableYears = [...new Set([...availableYears, ...years])].sort((a,b) => a-b);
                }
            }
            if(savedMan) allMandalartData = JSON.parse(savedMan);
        }

        function initYearSelect() {
            const select = document.getElementById('yearSelect');
            select.innerHTML = '';
            availableYears.forEach(y => {
                const opt = document.createElement('option');
                opt.value = y;
                opt.textContent = y + 'ë…„';
                if(y === currentYear) opt.selected = true;
                select.appendChild(opt);
            });
        }

        // ì—°ë„ ì¶”ê°€ í”„ë¡¬í”„íŠ¸
        window.addYearPrompt = function() {
            const input = prompt("ì¶”ê°€í•  ì—°ë„ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 2027)");
            if (!input) return;
            const newYear = parseInt(input);
            if (isNaN(newYear) || newYear < 2020 || newYear > 2050) {
                alert("ì˜¬ë°”ë¥¸ ì—°ë„ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }
            if (availableYears.includes(newYear)) {
                alert("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì—°ë„ì…ë‹ˆë‹¤.");
                changeYear(newYear);
                return;
            }
            
            // ìƒˆ ì—°ë„ ì¶”ê°€
            availableYears.push(newYear);
            availableYears.sort((a, b) => a - b);
            
            // ë°ì´í„° ì´ˆê¸°í™”
            if (!allBigstoneData[newYear]) allBigstoneData[newYear] = { bigstones: {}, todos: {} };
            if (!allMandalartData[newYear]) allMandalartData[newYear] = {};
            saveData(); 
            saveMandalart();

            initYearSelect(); // ì…€ë ‰íŠ¸ ë°•ìŠ¤ ê°±ì‹ 
            document.getElementById('yearSelect').value = newYear; // ìƒˆ ì—°ë„ ì„ íƒ
            changeYear(newYear); // ë·° ê°±ì‹ 
        };

        window.changeYear = function(year) {
            currentYear = parseInt(year);
            document.getElementById('yearSelect').value = currentYear; // UI ë™ê¸°í™”

            if (!allBigstoneData[currentYear]) allBigstoneData[currentYear] = { bigstones: {}, todos: {} };
            if (!allMandalartData[currentYear]) allMandalartData[currentYear] = {};
            
            data = allBigstoneData[currentYear];
            currentMandalartData = allMandalartData[currentYear];
            
            if(document.getElementById('bigstoneView').style.display !== 'none') {
                currentMonth !== null ? showMonthDetail(currentMonth) : renderYearView();
            } else {
                if(!mandalartInitialized) { createMandalartGrid(); mandalartInitialized=true; }
                updateMandalartGridFromData(currentMandalartData);
            }
        };

        function saveData() {
            allBigstoneData[currentYear] = data;
            localStorage.setItem('bigstoneYearlyData', JSON.stringify(allBigstoneData));
        }
        function saveMandalart() {
            allMandalartData[currentYear] = currentMandalartData;
            localStorage.setItem('mandalartYearlyData', JSON.stringify(allMandalartData));
        }

        // ... ë Œë”ë§ ë¡œì§ (ë¹…ìŠ¤í†¤, ë§Œë‹¤ë¼íŠ¸) ...
        function renderYearView() {
            const view = document.getElementById('yearView'); view.innerHTML = '';
            months.forEach((m, i) => {
                const card = document.createElement('div'); card.className = 'month-card';
                card.onclick = () => showMonthDetail(i);
                let preview = '';
                ['me','family','work'].forEach(c => {
                    const stones = data.bigstones[i]?.[c] || [];
                    if(stones.length) preview += `<div class="bigstone-category-title">${c=='me'?'ë‚˜':c=='family'?'ê°€ì¡±':'ì—…ë¬´'}</div>` + stones.slice(0,2).map(s=>`<div style="display:flex;gap:2px;font-size:11px;color:#666"><span>â€¢</span><span>${s.text}</span></div>`).join('');
                });
                card.innerHTML = `<div class="month-name">${m}</div><div class="bigstone-preview">${preview||'<span style="color:#ddd;font-size:11px">ëª©í‘œ ì—†ìŒ</span>'}</div>`;
                view.appendChild(card);
            });
        }

        function showMonthDetail(idx) {
            currentMonth = idx;
            document.getElementById('yearView').style.display = 'none';
            document.getElementById('monthDetail').classList.add('active');
            document.getElementById('monthTitle').textContent = `${currentYear}ë…„ ${months[idx]} ëª©í‘œ`;
            renderBigstones(idx); renderTodos(idx);
        }

        window.showYearView = function() {
            document.getElementById('yearView').style.display = 'grid';
            document.getElementById('monthDetail').classList.remove('active');
            currentMonth = null; renderYearView();
        };

        function renderBigstones(idx) {
            ['me','family','work'].forEach(c => {
                const el = document.getElementById(`bigstone-${c}`); el.innerHTML='';
                (data.bigstones[idx]?.[c]||[]).forEach((t,i) => el.appendChild(createTask(t, 'bigstone', c, i)));
            });
        }
        function renderTodos(idx) {
            const el = document.getElementById('todoList'); el.innerHTML='';
            (data.todos[idx]||[]).forEach((t,i) => el.appendChild(createTask(t, 'todo', 'general', i)));
        }

        function createTask(task, type, cat, idx) {
            const div = document.createElement('div'); div.className = 'task-item'; div.draggable = true;
            div.innerHTML = `<input type="checkbox" ${task.completed?'checked':''} onchange="toggleTask('${type}','${cat}',${idx})" style="width:20px;height:20px;margin:0">
                <div style="flex:1;margin-left:8px"><div class="task-text" style="${task.completed?'text-decoration:line-through;color:#aaa':''}">${task.text}</div>${task.deadline?`<div class="task-deadline">ğŸ“… ${task.deadline}</div>`:''}</div>
                <button style="border:none;background:none;cursor:pointer;color:#999" onclick="delTask('${type}','${cat}',${idx})">âœ•</button>`;
            
            div.ondragstart = e => { e.dataTransfer.setData('info', JSON.stringify({type, cat, idx})); };
            div.ondragover = e => e.preventDefault();
            div.ondrop = e => {
                e.preventDefault();
                const src = JSON.parse(e.dataTransfer.getData('info'));
                if(src.type !== type || src.cat !== cat) return;
                const arr = type==='bigstone' ? data.bigstones[currentMonth][cat] : data.todos[currentMonth];
                const [moved] = arr.splice(src.idx, 1);
                arr.splice(idx, 0, moved);
                saveData(); type==='bigstone'?renderBigstones(currentMonth):renderTodos(currentMonth);
            };
            return div;
        }

        window.showAddForm = (t, c) => {
            const f = document.getElementById(`form-${t}-${c}`);
            f.innerHTML = `<input id="in-${t}-${c}" placeholder="ë‚´ìš© ì…ë ¥"><input type="date" id="date-${t}-${c}"><div style="text-align:right"><button class="btn-secondary" onclick="this.parentElement.parentElement.classList.remove('active')">ì·¨ì†Œ</button> <button class="btn-primary" onclick="addT('${t}','${c}')" style="background:#1a73e8;color:white">ì €ì¥</button></div>`;
            f.classList.add('active');
        };

        window.addT = (t, c) => {
            const txt = document.getElementById(`in-${t}-${c}`).value;
            if(!txt) return;
            const task = { text: txt, deadline: document.getElementById(`date-${t}-${c}`).value, completed: false };
            if(t==='bigstone') {
                if(!data.bigstones[currentMonth]) data.bigstones[currentMonth]={};
                if(!data.bigstones[currentMonth][c]) data.bigstones[currentMonth][c]=[];
                data.bigstones[currentMonth][c].push(task);
            } else {
                if(!data.todos[currentMonth]) data.todos[currentMonth]=[];
                data.todos[currentMonth].push(task);
            }
            saveData();
            document.getElementById(`form-${t}-${c}`).classList.remove('active');
            t==='bigstone'?renderBigstones(currentMonth):renderTodos(currentMonth);
        };

        window.toggleTask = (t, c, i) => {
            const arr = t==='bigstone' ? data.bigstones[currentMonth][c] : data.todos[currentMonth];
            arr[i].completed = !arr[i].completed;
            saveData(); t==='bigstone'?renderBigstones(currentMonth):renderTodos(currentMonth);
        };

        window.delTask = (t, c, i) => {
            if(!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            const arr = t==='bigstone' ? data.bigstones[currentMonth][c] : data.todos[currentMonth];
            arr.splice(i, 1);
            saveData(); t==='bigstone'?renderBigstones(currentMonth):renderTodos(currentMonth);
        };

        // === ë§Œë‹¤ë¼íŠ¸ ===
        let mandalartInitialized = false;
        const CELL_MAP = [0, 1, 2, 3, 4, 5, 6, 7, 8]; 

        function createMandalartGrid() {
            const grid = document.getElementById('mandalart-grid');
            grid.innerHTML = '';
            for(let i=0; i<9; i++) {
                const subGrid = document.createElement('div');
                const isCenter = (i === 4);
                subGrid.className = `sub-grid sub-grid-${i} ${isCenter ? 'sub-grid-center' : ''}`;
                for(let j=0; j<9; j++) {
                    const cell = document.createElement('textarea');
                    cell.className = 'grid-cell';
                    cell.id = `mcell-${i}-${j}`;
                    cell.dataset.gridId = i; cell.dataset.cellId = j;
                    if(i===4 && j===4) { cell.classList.add('main-goal'); cell.placeholder = 'í•µì‹¬\nëª©í‘œ'; }
                    else if(i===4) { cell.classList.add('sub-goal'); cell.placeholder = 'ì„¸ë¶€\nëª©í‘œ'; }
                    else if(j===4) { cell.classList.add('sub-goal'); cell.readOnly = true; cell.placeholder = 'ì„¸ë¶€\nëª©í‘œ'; } 
                    else { cell.placeholder = 'ê³„íš'; }
                    cell.addEventListener('input', handleMandalartInput);
                    subGrid.appendChild(cell);
                }
                grid.appendChild(subGrid);
            }
        }

        function handleMandalartInput(e) {
            const cell = e.target;
            currentMandalartData[cell.id] = cell.value;
            saveMandalart();
            const gId = parseInt(cell.dataset.gridId), cId = parseInt(cell.dataset.cellId);
            if(gId === 4 && cId !== 4) {
                const targetEl = document.getElementById(`mcell-${cId}-4`);
                if(targetEl) targetEl.value = cell.value;
            }
        }

        function updateMandalartGridFromData(d) {
            if(!d) return;
            document.querySelectorAll('.grid-cell').forEach(cell => {
                if(d[cell.id]) cell.value = d[cell.id];
                const gId = parseInt(cell.dataset.gridId), cId = parseInt(cell.dataset.cellId);
                if(gId === 4 && cId !== 4) {
                    const targetEl = document.getElementById(`mcell-${cId}-4`);
                    if(targetEl) targetEl.value = cell.value;
                }
            });
        }

        window.switchTab = function(name) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.view-content').forEach(v => { v.style.display='none'; v.classList.remove('active'); });
            if(name === 'bigstone') document.getElementById('bigstoneView').style.display = 'block';
            else {
                document.getElementById('mandalartView').style.display = 'flex'; // Flex for center alignment
                if(!mandalartInitialized) { createMandalartGrid(); mandalartInitialized=true; }
                updateMandalartGridFromData(currentMandalartData);
            }
        };

        window.exportData = () => {
            const blob = new Blob([JSON.stringify({bigstones:allBigstoneData, mandalarts:allMandalartData},null,2)], {type:'application/json'});
            const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`bigstone_backup_${new Date().toISOString().slice(0,10)}.json`; a.click();
        };
        window.importData = e => {
            const r = new FileReader();
            r.onload = ev => {
                try {
                    const d = JSON.parse(ev.target.result);
                    if(d.bigstones) { allBigstoneData=d.bigstones; localStorage.setItem('bigstoneYearlyData', JSON.stringify(allBigstoneData)); }
                    if(d.mandalarts) { allMandalartData=d.mandalarts; localStorage.setItem('mandalartYearlyData', JSON.stringify(allMandalartData)); }
                    alert('ë°ì´í„° ë³µì› ì™„ë£Œ'); 
                    // ë³µì›ëœ ë°ì´í„°ì—ì„œ ì—°ë„ ëª©ë¡ ì¶”ì¶œí•˜ì—¬ ê°±ì‹ 
                    loadAllData(); initYearSelect(); changeYear(currentYear);
                } catch(err) { alert('íŒŒì¼ ì˜¤ë¥˜'); }
            };
            r.readAsText(e.target.files[0]);
        };

        init();
    </script>
</body>
</html>
