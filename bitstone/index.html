<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¹…ìŠ¤í†¤ - ëª©í‘œ ê´€ë¦¬</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; color: #202124; height: 100vh; overflow: hidden; }
        .container { max-width: 1400px; margin: 0 auto; padding: 10px; height: 100%; display: flex; flex-direction: column; }
        
        /* í—¤ë” ìŠ¤íƒ€ì¼ (ì»´íŒ©íŠ¸í•˜ê²Œ ìˆ˜ì •) */
        header { background: white; padding: 10px 20px; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); flex-shrink: 0; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .title-area { display: flex; align-items: center; gap: 15px; }
        h1 { font-size: 20px; font-weight: 600; color: #202124; }
        
        #yearSelect {
            padding: 4px 8px; font-size: 15px; font-weight: bold; color: #1a73e8;
            border: 1px solid #dadce0; border-radius: 4px; background: white; cursor: pointer;
        }

        .buttons { display: flex; gap: 8px; }
        button { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; transition: background 0.2s; }
        
        .btn-home { background: #fff; border: 1px solid #dadce0; color: #202124; font-weight: 700; }
        .btn-home:hover { background: #f1f3f4; }
        .btn-primary { background: #1a73e8; color: white; }
        .btn-primary:hover { background: #1765cc; }
        .btn-secondary { background: #f1f3f4; color: #202124; }
        .btn-secondary:hover { background: #e8eaed; }

        .tabs { display: flex; gap: 10px; border-bottom: 2px solid #e8eaed; }
        .tab { padding: 6px 12px; border: none; background: none; cursor: pointer; font-size: 14px; color: #5f6368; border-bottom: 3px solid transparent; }
        .tab:hover { color: #202124; background: #f8f9fa; }
        .tab.active { color: #1a73e8; border-bottom-color: #1a73e8; font-weight: 600; }

        /* ë·° ì˜ì—­ ê³µí†µ */
        .view-content { flex: 1; overflow-y: auto; display: none; min-height: 0; padding-bottom: 20px; }
        .view-content.active { display: block; }

        /* === ë¹…ìŠ¤í†¤ ë·° === */
        .year-view { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 20px; }
        .month-card { background: white; padding: 15px; border-radius: 8px; cursor: pointer; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.1); text-align: left; }
        .month-card:hover { box-shadow: 0 2px 6px rgba(0,0,0,0.15); transform: translateY(-2px); }
        .month-name { font-size: 16px; font-weight: 600; margin-bottom: 8px; text-align: center; padding-bottom: 8px; border-bottom: 2px solid #e8eaed; }
        .completion-status { font-size: 11px; color: #5f6368; text-align: center; margin-top: 8px; padding-top: 8px; border-top: 1px solid #e8eaed; }
        .bigstone-preview { font-size: 11px; min-height: 60px; }
        .bigstone-category-title { font-weight: 600; color: #1a73e8; margin-bottom: 2px; margin-top: 4px; }
        .bigstone-item { padding: 2px 0; color: #5f6368; display: flex; align-items: start; gap: 4px; }
        .bigstone-item::before { content: 'â€¢'; color: #1a73e8; }

        .month-detail { display: none; background: white; border-radius: 8px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); height: 100%; overflow-y: auto; }
        .month-detail.active { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .section { padding: 15px; background: #f8f9fa; border-radius: 8px; }
        .section-title { font-size: 16px; font-weight: 600; margin-bottom: 12px; }
        .category-name { font-size: 13px; font-weight: 600; color: #5f6368; margin-bottom: 8px; margin-top: 15px; }
        
        .task-item { background: white; padding: 10px; margin-bottom: 6px; border-radius: 4px; display: flex; align-items: flex-start; gap: 8px; border-left: 3px solid #1a73e8; cursor: move; }
        .task-text { font-size: 13px; font-weight: 500; }
        .task-deadline { font-size: 11px; color: #5f6368; }
        .add-task-form { margin-top: 10px; display: none; background: white; padding: 10px; border-radius: 4px; border: 1px solid #e0e0e0; }
        .add-task-form.active { display: block; }
        input, textarea { width: 100%; padding: 6px; margin-bottom: 6px; border: 1px solid #dadce0; border-radius: 4px; font-size: 13px; }

        /* === ë§Œë‹¤ë¼íŠ¸ ìŠ¤íƒ€ì¼ (ê°œì„ ë¨) === */
        .mandalart-container { 
            height: 100%; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            padding: 10px; /* ì—¬ë°± í™•ë³´ */
        }
        
        .mandalart-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            grid-template-rows: repeat(3, 1fr); 
            width: 100%; 
            max-width: 90vh; /* í™”ë©´ ë†’ì´ì— ë§ì¶° ìë™ ì¡°ì ˆ (ì˜ë¦¼ ë°©ì§€ í•µì‹¬) */
            aspect-ratio: 1 / 1; 
            gap: 6px; 
            padding: 6px; 
            background-color: #333; /* ì „ì²´ ì™¸ê³½ì„  ëŠë‚Œ */
            border-radius: 4px;
        }

        /* 3x3 ì„œë¸Œ ê·¸ë¦¬ë“œ */
        .sub-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            grid-template-rows: repeat(3, 1fr); 
            gap: 2px; 
            padding: 2px;
            background-color: #fff;
            border: 2px solid #555; /* êµ¬ì—­ë³„ êµµì€ í…Œë‘ë¦¬ */
        }

        /* ì¤‘ì•™ í•µì‹¬ ëª©í‘œ ê·¸ë¦¬ë“œ ê°•ì¡° */
        .sub-grid-center { 
            border: 3px solid #000; 
            z-index: 10;
        }

        .grid-cell { 
            width: 100%; height: 100%; 
            padding: 2px; 
            border: 1px solid #e0e0e0; 
            border-radius: 0; 
            resize: none; 
            font-size: 0.75rem; 
            text-align: center; 
            display: flex; align-items: center; justify-content: center; 
            word-break: keep-all; 
            line-height: 1.2;
            font-weight: 500;
        }
        
        .grid-cell:focus { outline: 2px solid #1a73e8; z-index: 5; }

        /* ìƒ‰ìƒ í…Œë§ˆ (ì°¸ê³  ì´ë¯¸ì§€ ê¸°ë°˜ íŒŒìŠ¤í…”í†¤ + ëª…í™•í•œ êµ¬ë¶„) */
        /* ì¢Œìƒ(0): í•‘í¬ */ .sub-grid-0 { background-color: #ffebee; } .sub-grid-0 .grid-cell { background-color: #ffebee; }
        /* ìƒ(1): ì£¼í™© */ .sub-grid-1 { background-color: #fff3e0; } .sub-grid-1 .grid-cell { background-color: #fff3e0; }
        /* ìš°ìƒ(2): ë…¸ë‘ */ .sub-grid-2 { background-color: #fffde7; } .sub-grid-2 .grid-cell { background-color: #fffde7; }
        /* ì¢Œ(3): ë³´ë¼ */ .sub-grid-3 { background-color: #f3e5f5; } .sub-grid-3 .grid-cell { background-color: #f3e5f5; }
        /* ì¤‘ì•™(4): íšŒìƒ‰ */ .sub-grid-center { background-color: #eceff1; } .sub-grid-center .grid-cell { background-color: #eceff1; }
        /* ìš°(5): íŒŒë‘ */ .sub-grid-5 { background-color: #e3f2fd; } .sub-grid-5 .grid-cell { background-color: #e3f2fd; }
        /* ì¢Œí•˜(6): ì´ˆë¡ */ .sub-grid-6 { background-color: #e8f5e9; } .sub-grid-6 .grid-cell { background-color: #e8f5e9; }
        /* í•˜(7): ë¯¼íŠ¸ */ .sub-grid-7 { background-color: #e0f2f1; } .sub-grid-7 .grid-cell { background-color: #e0f2f1; }
        /* ìš°í•˜(8): ê°ˆìƒ‰ */ .sub-grid-8 { background-color: #efebe9; } .sub-grid-8 .grid-cell { background-color: #efebe9; }

        /* í•µì‹¬ ëª©í‘œ ì…€ ê°•ì¡° */
        .main-goal { 
            background-color: #ffeb3b !important; 
            font-weight: 800; 
            font-size: 1rem; 
            border: 2px solid #fbc02d;
        }
        
        /* ì„¸ë¶€ ëª©í‘œ(ì¤‘ì•™) ì…€ ê°•ì¡° */
        .sub-goal { 
            background-color: #fff !important; 
            font-weight: 700; 
            border: 1px solid #999;
        }

        @media (max-width: 768px) {
            .month-detail.active { grid-template-columns: 1fr; }
            .mandalart-grid { max-width: 100%; height: auto; aspect-ratio: 1/1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-top">
                <div class="title-area">
                    <h1>ë¹…ìŠ¤í†¤ - ëª©í‘œ ê´€ë¦¬</h1>
                    <select id="yearSelect" onchange="changeYear(this.value)"></select>
                </div>
                <div class="buttons">
                    <button class="btn-home" onclick="location.href='../index.html'">ğŸ  í™ˆìœ¼ë¡œ</button>
                    <button class="btn-secondary" onclick="exportData()">ğŸ“¤ ë‚´ë³´ë‚´ê¸°</button>
                    <button class="btn-secondary" onclick="document.getElementById('importFile').click()">ğŸ“¥ ê°€ì ¸ì˜¤ê¸°</button>
                    <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
                </div>
            </div>
            <div class="tabs">
                <button class="tab active" onclick="switchTab('bigstone')">ë¹…ìŠ¤í†¤</button>
                <button class="tab" onclick="switchTab('mandalart')">ë§Œë‹¤ë¼íŠ¸</button>
            </div>
        </header>

        <div id="bigstoneView" class="view-content active">
            <div id="yearView" class="year-view"></div>
            <div id="monthDetail" class="month-detail">
                <div class="section">
                    <button class="btn-secondary" onclick="showYearView()" style="margin-bottom:10px;">â† ì „ì²´ ë³´ê¸°</button>
                    <div class="section-title"><span id="monthTitle">ë¹…ìŠ¤í†¤</span></div>
                    <div class="category"><div class="category-name">ë‚˜</div><div id="bigstone-me"></div><button class="btn-secondary" onclick="showAddForm('bigstone', 'me')">+ ì¶”ê°€</button><div id="form-bigstone-me" class="add-task-form"></div></div>
                    <div class="category"><div class="category-name">ê°€ì¡±</div><div id="bigstone-family"></div><button class="btn-secondary" onclick="showAddForm('bigstone', 'family')">+ ì¶”ê°€</button><div id="form-bigstone-family" class="add-task-form"></div></div>
                    <div class="category"><div class="category-name">ì—…ë¬´</div><div id="bigstone-work"></div><button class="btn-secondary" onclick="showAddForm('bigstone', 'work')">+ ì¶”ê°€</button><div id="form-bigstone-work" class="add-task-form"></div></div>
                </div>
                <div class="section">
                    <div class="section-title"><span>í•  ì¼ ë¦¬ìŠ¤íŠ¸</span></div>
                    <div id="todoList"></div>
                    <button class="btn-secondary" onclick="showAddForm('todo', 'general')">+ í•  ì¼ ì¶”ê°€</button>
                    <div id="form-todo-general" class="add-task-form"></div>
                </div>
            </div>
        </div>

        <div id="mandalartView" class="view-content mandalart-container">
            <div id="mandalart-grid" class="mandalart-grid"></div>
        </div>
    </div>

    <script>
        const months = ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'];
        let currentYear = 2026; // ê¸°ë³¸ 2026ë…„ ì‹œì‘
        let currentMonth = null;
        let allBigstoneData = {}; 
        let allMandalartData = {}; 
        let data = { bigstones: {}, todos: {} }; 
        let currentMandalartData = {};

        function init() {
            initYearSelect();
            loadAllData();
            changeYear(currentYear);
        }

        function initYearSelect() {
            const select = document.getElementById('yearSelect');
            select.innerHTML = '';
            // 2026ë…„ë§Œ ìš°ì„  í‘œì‹œ, ë‚´ë…„ì— ì¶”ê°€í•˜ë©´ ë¨
            const opt = document.createElement('option');
            opt.value = 2026;
            opt.textContent = '2026ë…„';
            opt.selected = true;
            select.appendChild(opt);
            
            // í•„ìš” ì‹œ ì£¼ì„ í•´ì œí•˜ì—¬ ì—°ë„ í™•ì¥ ê°€ëŠ¥
            /*
            for(let y = 2025; y <= 2028; y++) {
                const opt = document.createElement('option');
                opt.value = y; opt.textContent = y + 'ë…„';
                if(y === currentYear) opt.selected = true;
                select.appendChild(opt);
            }
            */
        }

        function loadAllData() {
            const savedBig = localStorage.getItem('bigstoneYearlyData');
            const savedMan = localStorage.getItem('mandalartYearlyData');
            if(savedBig) allBigstoneData = JSON.parse(savedBig);
            if(savedMan) allMandalartData = JSON.parse(savedMan);
        }

        window.changeYear = function(year) {
            currentYear = parseInt(year);
            if (!allBigstoneData[currentYear]) allBigstoneData[currentYear] = { bigstones: {}, todos: {} };
            if (!allMandalartData[currentYear]) allMandalartData[currentYear] = {};
            data = allBigstoneData[currentYear];
            currentMandalartData = allMandalartData[currentYear];
            
            if(document.getElementById('bigstoneView').style.display !== 'none') {
                currentMonth !== null ? showMonthDetail(currentMonth) : renderYearView();
            } else {
                if(!mandalartInitialized) { createMandalartGrid(); mandalartInitialized=true; }
                updateMandalartGridFromData(currentMandalartData);
            }
        };

        function saveData() {
            allBigstoneData[currentYear] = data;
            localStorage.setItem('bigstoneYearlyData', JSON.stringify(allBigstoneData));
        }
        function saveMandalart() {
            allMandalartData[currentYear] = currentMandalartData;
            localStorage.setItem('mandalartYearlyData', JSON.stringify(allMandalartData));
        }

        // --- ë·° ë Œë”ë§ ---
        function renderYearView() {
            const view = document.getElementById('yearView'); view.innerHTML = '';
            months.forEach((m, i) => {
                const card = document.createElement('div'); card.className = 'month-card';
                card.onclick = () => showMonthDetail(i);
                
                // ë¯¸ë¦¬ë³´ê¸° ìƒì„±
                let preview = '';
                ['me','family','work'].forEach(c => {
                    const stones = data.bigstones[i]?.[c] || [];
                    if(stones.length) preview += `<div class="bigstone-category-title">${c=='me'?'ë‚˜':c=='family'?'ê°€ì¡±':'ì—…ë¬´'}</div>` + stones.slice(0,2).map(s=>`<div class="bigstone-item"> ${s.text}</div>`).join('');
                });

                card.innerHTML = `<div class="month-name">${m}</div><div class="bigstone-preview">${preview||'<span style="color:#ddd">ëª©í‘œ ì—†ìŒ</span>'}</div>`;
                view.appendChild(card);
            });
        }

        function showMonthDetail(idx) {
            currentMonth = idx;
            document.getElementById('yearView').style.display = 'none';
            document.getElementById('monthDetail').classList.add('active');
            document.getElementById('monthTitle').textContent = `${currentYear}ë…„ ${months[idx]} ëª©í‘œ`;
            renderBigstones(idx); renderTodos(idx);
        }

        window.showYearView = function() {
            document.getElementById('yearView').style.display = 'grid';
            document.getElementById('monthDetail').classList.remove('active');
            currentMonth = null; renderYearView();
        };

        function renderBigstones(idx) {
            ['me','family','work'].forEach(c => {
                const el = document.getElementById(`bigstone-${c}`); el.innerHTML='';
                (data.bigstones[idx]?.[c]||[]).forEach((t,i) => el.appendChild(createTask(t, 'bigstone', c, i)));
            });
        }
        function renderTodos(idx) {
            const el = document.getElementById('todoList'); el.innerHTML='';
            (data.todos[idx]||[]).forEach((t,i) => el.appendChild(createTask(t, 'todo', 'general', i)));
        }

        function createTask(task, type, cat, idx) {
            const div = document.createElement('div'); div.className = 'task-item'; div.draggable = true;
            div.innerHTML = `<input type="checkbox" ${task.completed?'checked':''} onchange="toggleTask('${type}','${cat}',${idx})">
                <div style="flex:1"><div class="task-text" style="${task.completed?'text-decoration:line-through;color:#aaa':''}">${task.text}</div>${task.deadline?`<div class="task-deadline">ğŸ“… ${task.deadline}</div>`:''}</div>
                <button style="border:none;background:none;cursor:pointer;color:#999" onclick="delTask('${type}','${cat}',${idx})">ğŸ—‘ï¸</button>`;
            
            // ë“œë˜ê·¸ ì´ë²¤íŠ¸ (ê°„ì†Œí™”)
            div.ondragstart = e => { e.dataTransfer.setData('info', JSON.stringify({type, cat, idx})); };
            div.ondragover = e => e.preventDefault();
            div.ondrop = e => {
                e.preventDefault();
                const src = JSON.parse(e.dataTransfer.getData('info'));
                if(src.type !== type || src.cat !== cat) return;
                const arr = type==='bigstone' ? data.bigstones[currentMonth][cat] : data.todos[currentMonth];
                const [moved] = arr.splice(src.idx, 1);
                arr.splice(idx, 0, moved);
                saveData(); type==='bigstone'?renderBigstones(currentMonth):renderTodos(currentMonth);
            };
            return div;
        }

        window.showAddForm = (t, c) => {
            const f = document.getElementById(`form-${t}-${c}`);
            f.innerHTML = `<input id="in-${t}-${c}" placeholder="í•  ì¼"><input type="date" id="date-${t}-${c}"><div style="text-align:right"><button class="btn-secondary" onclick="this.parentElement.parentElement.classList.remove('active')">ì·¨ì†Œ</button> <button class="btn-primary" onclick="addT('${t}','${c}')">ì €ì¥</button></div>`;
            f.classList.add('active');
        };

        window.addT = (t, c) => {
            const txt = document.getElementById(`in-${t}-${c}`).value;
            if(!txt) return;
            const task = { text: txt, deadline: document.getElementById(`date-${t}-${c}`).value, completed: false };
            
            if(t==='bigstone') {
                if(!data.bigstones[currentMonth]) data.bigstones[currentMonth]={};
                if(!data.bigstones[currentMonth][c]) data.bigstones[currentMonth][c]=[];
                data.bigstones[currentMonth][c].push(task);
            } else {
                if(!data.todos[currentMonth]) data.todos[currentMonth]=[];
                data.todos[currentMonth].push(task);
            }
            saveData();
            document.getElementById(`form-${t}-${c}`).classList.remove('active');
            t==='bigstone'?renderBigstones(currentMonth):renderTodos(currentMonth);
        };

        window.toggleTask = (t, c, i) => {
            const arr = t==='bigstone' ? data.bigstones[currentMonth][c] : data.todos[currentMonth];
            arr[i].completed = !arr[i].completed;
            saveData(); t==='bigstone'?renderBigstones(currentMonth):renderTodos(currentMonth);
        };

        window.delTask = (t, c, i) => {
            if(!confirm('ì‚­ì œ?')) return;
            const arr = t==='bigstone' ? data.bigstones[currentMonth][c] : data.todos[currentMonth];
            arr.splice(i, 1);
            saveData(); t==='bigstone'?renderBigstones(currentMonth):renderTodos(currentMonth);
        };

        // === ë§Œë‹¤ë¼íŠ¸ (ìƒ‰ìƒ êµ¬ë¶„ ë° ë ˆì´ì•„ì›ƒ ìˆ˜ì •) ===
        let mandalartInitialized = false;
        // 3x3 ê·¸ë¦¬ë“œ ë§¤í•‘ (ì¤‘ì•™ì´ 4)
        const CELL_MAP = [0, 1, 2, 3, 4, 5, 6, 7, 8]; 

        function createMandalartGrid() {
            const grid = document.getElementById('mandalart-grid');
            grid.innerHTML = '';
            
            // 9ê°œì˜ ì„œë¸Œ ê·¸ë¦¬ë“œ ìƒì„±
            for(let i=0; i<9; i++) {
                const subGrid = document.createElement('div');
                // ì¤‘ì•™ ê·¸ë¦¬ë“œ(4ë²ˆ)ì¸ì§€ ì™¸ê³½ì¸ì§€ êµ¬ë¶„
                const isCenter = (i === 4);
                subGrid.className = `sub-grid sub-grid-${i} ${isCenter ? 'sub-grid-center' : ''}`;
                
                for(let j=0; j<9; j++) {
                    const cell = document.createElement('textarea');
                    cell.className = 'grid-cell';
                    cell.id = `mcell-${i}-${j}`; // ê³ ìœ  ID
                    cell.dataset.gridId = i;
                    cell.dataset.cellId = j;

                    // í•µì‹¬ ëª©í‘œ (ì •ì¤‘ì•™ì˜ ì •ì¤‘ì•™)
                    if(i===4 && j===4) { 
                        cell.classList.add('main-goal'); 
                        cell.placeholder = 'í•µì‹¬\nëª©í‘œ';
                    }
                    // ì„¸ë¶€ ëª©í‘œ (ì¤‘ì•™ ê·¸ë¦¬ë“œì˜ ì£¼ë³€ 8ê°œ)
                    else if(i===4) {
                        cell.classList.add('sub-goal');
                        cell.placeholder = 'ì„¸ë¶€\nëª©í‘œ';
                    }
                    // ê° ì™¸ê³½ ê·¸ë¦¬ë“œì˜ ì¤‘ì‹¬ (ì„¸ë¶€ ëª©í‘œì™€ ì—°ë™ë¨)
                    else if(j===4) {
                        cell.classList.add('sub-goal');
                        cell.readOnly = true; // ì¤‘ì•™ì—ì„œ ìˆ˜ì •í•˜ë©´ ìë™ ë°˜ì˜ë˜ë¯€ë¡œ ì½ê¸° ì „ìš©
                        cell.placeholder = 'ì„¸ë¶€\nëª©í‘œ';
                    } 
                    else {
                        cell.placeholder = 'ê³„íš';
                    }

                    cell.addEventListener('input', handleMandalartInput);
                    subGrid.appendChild(cell);
                }
                grid.appendChild(subGrid);
            }
        }

        function handleMandalartInput(e) {
            const cell = e.target;
            currentMandalartData[cell.id] = cell.value;
            saveMandalart();

            // ì¤‘ì•™ ê·¸ë¦¬ë“œ(4ë²ˆ)ì˜ ê°’ì´ ë³€ê²½ë˜ë©´ -> ì™¸ê³½ ê·¸ë¦¬ë“œì˜ ì¤‘ì‹¬(4ë²ˆ ì…€)ìœ¼ë¡œ ìë™ ì „íŒŒ
            const gId = parseInt(cell.dataset.gridId);
            const cId = parseInt(cell.dataset.cellId);

            if(gId === 4 && cId !== 4) {
                // ì¤‘ì•™ ê·¸ë¦¬ë“œì˜ cId ìœ„ì¹˜ëŠ” ì™¸ê³½ ê·¸ë¦¬ë“œ cIdë²ˆì˜ ì¤‘ì‹¬(4ë²ˆ ì…€)ê³¼ ë§¤ì¹­
                // ì˜ˆ: ì¤‘ì•™ì˜ 0ë²ˆ ì…€(ì¢Œìƒë‹¨) ìˆ˜ì • -> 0ë²ˆ ê·¸ë¦¬ë“œì˜ 4ë²ˆ ì…€(ì¤‘ì‹¬) ì—…ë°ì´íŠ¸
                const targetId = `mcell-${cId}-4`;
                const targetEl = document.getElementById(targetId);
                if(targetEl) targetEl.value = cell.value;
            }
        }

        function updateMandalartGridFromData(d) {
            if(!d) return;
            document.querySelectorAll('.grid-cell').forEach(cell => {
                if(d[cell.id]) cell.value = d[cell.id];
                
                // ì—°ë™ ë°ì´í„° ê°•ì œ ì—…ë°ì´íŠ¸ (ì½ê¸° ì „ìš© ì…€ ì±„ìš°ê¸°)
                const gId = parseInt(cell.dataset.gridId);
                const cId = parseInt(cell.dataset.cellId);
                if(gId === 4 && cId !== 4) {
                    const targetId = `mcell-${cId}-4`;
                    const targetEl = document.getElementById(targetId);
                    if(targetEl) targetEl.value = cell.value;
                }
            });
        }

        window.switchTab = function(name) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.view-content').forEach(v => { v.style.display='none'; v.classList.remove('active'); });
            
            if(name === 'bigstone') {
                document.getElementById('bigstoneView').style.display = 'block';
            } else {
                document.getElementById('mandalartView').style.display = 'flex';
                if(!mandalartInitialized) { createMandalartGrid(); mandalartInitialized=true; }
                updateMandalartGridFromData(currentMandalartData);
            }
        };

        window.exportData = () => {
            const blob = new Blob([JSON.stringify({bigstones:allBigstoneData, mandalarts:allMandalartData},null,2)], {type:'application/json'});
            const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='bigstone_backup.json'; a.click();
        };
        window.importData = e => {
            const r = new FileReader();
            r.onload = ev => {
                const d = JSON.parse(ev.target.result);
                if(d.bigstones) { allBigstoneData=d.bigstones; localStorage.setItem('bigstoneYearlyData', JSON.stringify(allBigstoneData)); }
                if(d.mandalarts) { allMandalartData=d.mandalarts; localStorage.setItem('mandalartYearlyData', JSON.stringify(allMandalartData)); }
                alert('ì™„ë£Œ'); location.reload();
            };
            r.readAsText(e.target.files[0]);
        };

        init();
    </script>
</body>
</html>
