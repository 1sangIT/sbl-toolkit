<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë¹…ìŠ¤í†¤ - ëª©í‘œ ê´€ë¦¬ (Cloud)</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: #f5f5f5; color: #202124; 
            height: 100vh; overflow: hidden; display: flex; flex-direction: column;
        }

        .container { 
            width: 100%; max-width: 1400px; margin: 0 auto; 
            height: 100%; display: flex; flex-direction: column; padding: 10px;
        }
        
        header { 
            background: white; padding: 10px 15px; border-radius: 8px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); flex-shrink: 0; z-index: 100;
        }

        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .title-area { display: flex; align-items: center; gap: 8px; }
        h1 { font-size: 18px; font-weight: 700; color: #202124; white-space: nowrap; }
        
        .year-control { display: flex; align-items: center; gap: 4px; }
        #yearSelect {
            padding: 4px 2px; font-size: 15px; font-weight: bold; color: #1a73e8;
            border: 1px solid #dadce0; border-radius: 4px; background: white; cursor: pointer;
        }
        .btn-add-year {
            background: #e8f0fe; color: #1a73e8; border: none; border-radius: 4px;
            width: 24px; height: 24px; font-size: 16px; font-weight: bold; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        
        .user-info { display: flex; align-items: center; gap: 8px; margin-right: 10px; }
        .user-avatar { width: 28px; height: 28px; border-radius: 50%; border: 1px solid #ddd; }
        .login-btn { background: #1a73e8; color: white; padding: 6px 12px; border-radius: 4px; border: none; font-weight: bold; cursor: pointer; }

        .buttons { display: flex; gap: 6px; align-items: center; }
        button { padding: 6px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; transition: background 0.2s; white-space: nowrap; }
        .btn-home { background: #fff; border: 1px solid #dadce0; color: #202124; font-weight: 700; }
        .btn-secondary { background: #f1f3f4; color: #202124; }

        .tabs { display: flex; gap: 10px; border-bottom: 1px solid #e0e0e0; }
        .tab { padding: 6px 12px; border: none; background: none; cursor: pointer; font-size: 14px; color: #5f6368; border-bottom: 2px solid transparent; font-weight: 600; }
        .tab.active { color: #1a73e8; border-bottom-color: #1a73e8; }

        .view-content { flex: 1; overflow-y: auto; display: none; padding: 10px 0 20px 0; }
        .view-content.active { display: block; }

        /* === ë§Œë‹¤ë¼íŠ¸ ìŠ¤íƒ€ì¼ === */
        .mandalart-container { 
            height: 100%; display: none; flex-direction: column;
            align-items: center; justify-content: center; overflow: hidden; 
        }
        .mandalart-container.active { display: flex; }
        
        .mandalart-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            grid-template-rows: repeat(3, 1fr); 
            width: 100%;
            max-width: calc(100vh - 130px); 
            aspect-ratio: 1 / 1; 
            gap: 4px; padding: 4px; 
            background-color: #333; border-radius: 4px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .sub-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            grid-template-rows: repeat(3, 1fr); 
            gap: 1px; padding: 1px; background-color: #fff;
            border: 2px solid #555;
        }
        .sub-grid-center { border: 3px solid #000; z-index: 10; }

        /* ì…€ ë˜í¼: ì •ì¤‘ì•™ ì •ë ¬ì„ ìœ„í•œ Flex ì»¨í…Œì´ë„ˆ */
        .cell-wrapper {
            width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            padding: 2px; border: 1px solid #eee;
        }

        /* í…ìŠ¤íŠ¸ ì…ë ¥ì°½: íˆ¬ëª…í•˜ê³  ê½‰ ì°¨ê²Œ */
        .grid-input { 
            width: 100%; 
            background: transparent; border: none; outline: none; resize: none;
            text-align: center; font-size: 0.8rem; font-weight: 600;
            font-family: inherit; line-height: 1.3;
            overflow: hidden;
            /* ë†’ì´ë¥¼ ë‚´ìš©ë¬¼ì— ë§ì¶”ê±°ë‚˜ 100%ë¡œ í•˜ë˜, Flex ì¤‘ì•™ ì •ë ¬ íš¨ê³¼ë¥¼ ìœ„í•´ */
            height: 100%; 
            display: flex; flex-direction: column; justify-content: center;
        }
        /* placeholder ìƒ‰ìƒ */
        .grid-input::placeholder { color: #aaa; font-weight: 400; }
        .grid-input:focus { background-color: rgba(26, 115, 232, 0.1); }

        /* ìƒ‰ìƒ í…Œë§ˆ */
        .sub-grid-0, .sub-grid-0 .cell-wrapper, .sub-grid-0 textarea { background-color: #ffebee; }
        .sub-grid-1, .sub-grid-1 .cell-wrapper, .sub-grid-1 textarea { background-color: #fff3e0; }
        .sub-grid-2, .sub-grid-2 .cell-wrapper, .sub-grid-2 textarea { background-color: #fffde7; }
        .sub-grid-3, .sub-grid-3 .cell-wrapper, .sub-grid-3 textarea { background-color: #f3e5f5; }
        .sub-grid-center, .sub-grid-center .cell-wrapper, .sub-grid-center textarea { background-color: #eceff1; }
        .sub-grid-5, .sub-grid-5 .cell-wrapper, .sub-grid-5 textarea { background-color: #e3f2fd; }
        .sub-grid-6, .sub-grid-6 .cell-wrapper, .sub-grid-6 textarea { background-color: #e8f5e9; }
        .sub-grid-7, .sub-grid-7 .cell-wrapper, .sub-grid-7 textarea { background-color: #e0f2f1; }
        .sub-grid-8, .sub-grid-8 .cell-wrapper, .sub-grid-8 textarea { background-color: #efebe9; }

        .main-goal, .main-goal .cell-wrapper, .main-goal textarea { background-color: #ffeb3b !important; font-weight: 800; font-size: 1.1rem; }
        .sub-goal, .sub-goal .cell-wrapper, .sub-goal textarea { background-color: #fff !important; font-weight: 700; }
        
        /* ì¤‘ì•™ ì…€ í…Œë‘ë¦¬ ê°•ì¡° */
        .main-goal .cell-wrapper { border: 2px solid #fbc02d; }
        .sub-goal .cell-wrapper { border: 1px solid #999; }

        /* === ë¹…ìŠ¤í†¤ ë·° === */
        .year-view { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; }
        .month-card { background: white; padding: 12px; border-radius: 8px; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .month-name { font-weight: 700; text-align: center; border-bottom: 2px solid #eee; padding-bottom: 5px; margin-bottom: 5px; }
        .bigstone-preview { min-height: 50px; font-size: 11px; }
        
        .month-detail { display: none; height: 100%; grid-template-columns: 1fr 1fr; gap: 15px; }
        .month-detail.active { display: grid; }
        .section { background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #eee; overflow-y: auto; }
        
        .task-item { background: #f8f9fa; padding: 8px; margin-bottom: 5px; border-radius: 4px; display: flex; align-items: center; border-left: 3px solid #1a73e8; }
        .add-task-form.active { display: block; padding: 10px; background: #eee; border-radius: 4px; margin-top: 5px; }
        .add-task-form { display: none; }
        input, textarea { width: 100%; padding: 6px; margin-bottom: 5px; border: 1px solid #ccc; border-radius: 4px; }

        @media (max-width: 768px) {
            .month-detail.active { grid-template-columns: 1fr; grid-template-rows: 1fr 1fr; }
            .mandalart-grid { max-width: 100%; margin-top: 10px; }
            .buttons span { display: none; }
            .user-info span { display: none; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-top">
                <div class="title-area">
                    <h1>ë¹…ìŠ¤í†¤</h1>
                    <div class="year-control">
                        <select id="yearSelect" onchange="changeYear(this.value)"></select>
                        <button class="btn-add-year" onclick="addYearPrompt()" title="ì—°ë„ ì¶”ê°€">+</button>
                    </div>
                </div>
                
                <div class="buttons">
                    <div id="loginArea" class="user-info" style="display:none;">
                        <button class="login-btn" onclick="googleLogin()">ë¡œê·¸ì¸</button>
                    </div>
                    <div id="userArea" class="user-info" style="display:none;">
                        <img id="userAvatar" class="user-avatar" src="">
                        <span id="userName" style="font-size:13px; font-weight:600;"></span>
                    </div>

                    <button class="btn-home" onclick="location.href='../index.html'">ğŸ  <span>í™ˆìœ¼ë¡œ</span></button>
                    <button class="btn-secondary" onclick="exportData()">ğŸ“¤ <span>ë°±ì—…</span></button>
                </div>
            </div>
            <div class="tabs">
                <button class="tab active" onclick="switchTab('bigstone')">ë¹…ìŠ¤í†¤</button>
                <button class="tab" onclick="switchTab('mandalart')">ë§Œë‹¤ë¼íŠ¸</button>
            </div>
        </header>

        <div id="bigstoneView" class="view-content active">
            <div id="yearView" class="year-view"></div>
            <div id="monthDetail" class="month-detail">
                <div class="section">
                    <button class="btn-secondary" onclick="showYearView()" style="margin-bottom:10px;">â† ì „ì²´ ëª©ë¡</button>
                    <h3 id="monthTitle" style="margin-bottom:10px; font-weight:700"></h3>
                    <div id="categories-wrapper"></div>
                </div>
                <div class="section">
                    <h3 style="margin-bottom:10px; font-weight:700">ì„¸ë¶€ ì‹¤í–‰ ê³„íš (To-Do)</h3>
                    <div id="todoList"></div>
                    <button class="btn-secondary" onclick="showAddForm('todo', 'general')" style="width:100%; margin-top:10px">+ í•  ì¼ ì¶”ê°€</button>
                    <div id="form-todo-general" class="add-task-form"></div>
                </div>
            </div>
        </div>

        <div id="mandalartView" class="mandalart-container">
            <div id="mandalart-grid" class="mandalart-grid"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-database.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAd08tVXgWZ2_dg3jzvhawmH4jtolRmfhY",
            authDomain: "itnews-82b60.firebaseapp.com",
            databaseURL: "https://itnews-82b60-default-rtdb.firebaseio.com",
            projectId: "itnews-82b60",
            storageBucket: "itnews-82b60.firebasestorage.app",
            messagingSenderId: "719267588761",
            appId: "1:719267588761:web:3c4607cb799620f9446608"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        const ALLOWED = "eundang@gmail.com";

        window.currentYear = 2026;
        window.currentMonth = null;
        let currentUserId = null;
        
        let allBigstoneData = {}; 
        let allMandalartData = {}; 
        let availableYears = [2026];

        onAuthStateChanged(auth, (user) => {
            if (user && user.email.toLowerCase() === ALLOWED) {
                currentUserId = user.uid;
                document.getElementById('loginArea').style.display = 'none';
                document.getElementById('userArea').style.display = 'flex';
                document.getElementById('userAvatar').src = user.photoURL;
                document.getElementById('userName').textContent = user.displayName;
                loadFromCloud();
            } else {
                document.getElementById('loginArea').style.display = 'block';
                document.getElementById('userArea').style.display = 'none';
                if(user) alert("ê¶Œí•œì´ ì—†ëŠ” ê³„ì •ì…ë‹ˆë‹¤.");
            }
        });

        window.googleLogin = () => signInWithPopup(auth, new GoogleAuthProvider());

        function loadFromCloud() {
            if(!currentUserId) return;
            onValue(ref(db, `users/${currentUserId}/bigstone`), (snapshot) => {
                const val = snapshot.val();
                if(val) {
                    allBigstoneData = val;
                    const years = Object.keys(allBigstoneData).map(Number).filter(y => !isNaN(y));
                    if (years.length > 0) {
                        availableYears = [...new Set([...availableYears, ...years])].sort((a,b) => a-b);
                        initYearSelect();
                    }
                }
                refreshView();
            });
            onValue(ref(db, `users/${currentUserId}/mandalart`), (snapshot) => {
                const val = snapshot.val();
                if(val) allMandalartData = val;
                refreshView();
            });
        }

        // í†µí•© ì €ì¥ í•¨ìˆ˜
        function saveToCloud() {
            if(!currentUserId) return;
            set(ref(db, `users/${currentUserId}/bigstone`), allBigstoneData);
            set(ref(db, `users/${currentUserId}/mandalart`), allMandalartData);
        }

        function initYearSelect() {
            const select = document.getElementById('yearSelect');
            select.innerHTML = '';
            availableYears.forEach(y => {
                const opt = document.createElement('option');
                opt.value = y; opt.textContent = y + 'ë…„';
                if(y === window.currentYear) opt.selected = true;
                select.appendChild(opt);
            });
        }

        window.addYearPrompt = function() {
            const input = prompt("ì¶”ê°€í•  ì—°ë„ (ì˜ˆ: 2027)");
            if (!input) return;
            const y = parseInt(input);
            if (isNaN(y) || y < 2020 || y > 2050) return alert("ì˜¬ë°”ë¥¸ ì—°ë„ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            if(!availableYears.includes(y)) {
                availableYears.push(y);
                availableYears.sort((a,b)=>a-b);
                initYearSelect();
            }
            window.changeYear(y);
        };

        window.changeYear = function(year) {
            window.currentYear = parseInt(year);
            document.getElementById('yearSelect').value = window.currentYear;
            refreshView();
        };

        function refreshView() {
            if (!allBigstoneData[window.currentYear]) allBigstoneData[window.currentYear] = { bigstones: {}, todos: {} };
            if (!allMandalartData[window.currentYear]) allMandalartData[window.currentYear] = {};
            
            if(document.getElementById('bigstoneView').style.display !== 'none') {
                window.currentMonth !== null ? showMonthDetail(window.currentMonth) : renderYearView();
            } else {
                renderMandalart();
            }
        }

        const months = ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'];
        
        function renderYearView() {
            const view = document.getElementById('yearView'); view.innerHTML = '';
            const data = allBigstoneData[window.currentYear];
            months.forEach((m, i) => {
                const card = document.createElement('div'); card.className = 'month-card';
                card.onclick = () => showMonthDetail(i);
                let preview = '';
                ['me','family','work'].forEach(c => {
                    const stones = data.bigstones[i]?.[c] || [];
                    if(stones.length) {
                        const label = c==='me'?'ë‚˜':c==='family'?'ê°€ì¡±':'ì—…ë¬´';
                        preview += `<div style="font-size:11px;font-weight:bold;color:#1a73e8;margin-top:4px">${label}</div>` + 
                                   stones.slice(0,2).map(s=>`<div style="font-size:11px;color:#666;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">â€¢ ${s.text}</div>`).join('');
                    }
                });
                card.innerHTML = `<div class="month-name">${m}</div><div class="bigstone-preview">${preview||'<span style="color:#ddd;font-size:11px">ëª©í‘œ ì—†ìŒ</span>'}</div>`;
                view.appendChild(card);
            });
        }

        window.showMonthDetail = function(idx) {
            window.currentMonth = idx;
            document.getElementById('yearView').style.display = 'none';
            document.getElementById('monthDetail').classList.add('active');
            document.getElementById('monthTitle').textContent = `${window.currentYear}ë…„ ${months[idx]} ëª©í‘œ`;
            
            const wrapper = document.getElementById('categories-wrapper');
            wrapper.innerHTML = '';
            ['me', 'family', 'work'].forEach(cat => {
                const label = cat==='me'?'ë‚˜ (Self)':cat==='family'?'ê°€ì¡± (Family)':'ì—…ë¬´ (Work)';
                const div = document.createElement('div');
                div.className = 'category-group';
                div.innerHTML = `
                    <h4 style="color:#555; margin:15px 0 5px;">${label}</h4>
                    <div id="bigstone-${cat}"></div>
                    <button class="btn-secondary" onclick="showAddForm('bigstone', '${cat}')" style="width:100%; margin-top:5px; font-size:12px;">+ ëª©í‘œ ì¶”ê°€</button>
                    <div id="form-bigstone-${cat}" class="add-task-form"></div>
                `;
                wrapper.appendChild(div);
                renderTasks('bigstone', cat);
            });
            renderTasks('todo', 'general');
        };

        window.showYearView = function() {
            document.getElementById('yearView').style.display = 'grid';
            document.getElementById('monthDetail').classList.remove('active');
            window.currentMonth = null; 
            renderYearView();
        };

        function renderTasks(type, cat) {
            const container = type==='bigstone' ? document.getElementById(`bigstone-${cat}`) : document.getElementById('todoList');
            if(!container) return;
            container.innerHTML = '';
            const data = allBigstoneData[window.currentYear];
            const list = type==='bigstone' ? (data.bigstones[window.currentMonth]?.[cat] || []) : (data.todos[window.currentMonth] || []);
            list.forEach((t, i) => {
                const div = document.createElement('div'); div.className = 'task-item';
                div.innerHTML = `
                    <input type="checkbox" ${t.completed?'checked':''} onchange="toggleTask('${type}','${cat}',${i})" style="width:18px;height:18px;margin:0">
                    <div style="flex:1;margin-left:8px">
                        <div style="${t.completed?'text-decoration:line-through;color:#aaa':''} font-size:13px; font-weight:500;">${t.text}</div>
                        ${t.deadline?`<div style="font-size:11px;color:#888">ğŸ“… ${t.deadline}</div>`:''}
                    </div>
                    <button style="border:none;background:none;cursor:pointer;color:#999" onclick="delTask('${type}','${cat}',${i})">âœ•</button>
                `;
                container.appendChild(div);
            });
        }

        // === ë§Œë‹¤ë¼íŠ¸ (textareaë¡œ ë³€ê²½í•˜ì—¬ í•œê¸€ ì…ë ¥ ë¬¸ì œ í•´ê²°) ===
        window.renderMandalart = function() {
            const grid = document.getElementById('mandalart-grid');
            if(grid.children.length === 0) createMandalartGrid(grid);
            const data = allMandalartData[window.currentYear] || {};
            
            // ëª¨ë“  textareaì— ê°’ ì±„ìš°ê¸°
            document.querySelectorAll('.grid-input').forEach(input => {
                input.value = data[input.id] || '';
                
                // ì™¸ê³½ ê·¸ë¦¬ë“œì˜ ì¤‘ì•™ ì…€(readOnly) ë™ê¸°í™”
                const gId = parseInt(input.dataset.gridId), cId = parseInt(input.dataset.cellId);
                if(gId === 4 && cId !== 4) {
                    const target = document.getElementById(`mcell-${cId}-4`);
                    if(target) target.value = input.value;
                }
            });
        }

        function createMandalartGrid(grid) {
            grid.innerHTML = '';
            for(let i=0; i<9; i++) {
                const subGrid = document.createElement('div');
                const isCenter = (i === 4);
                subGrid.className = `sub-grid sub-grid-${i} ${isCenter ? 'sub-grid-center' : ''}`;
                
                for(let j=0; j<9; j++) {
                    const cellWrapper = document.createElement('div');
                    cellWrapper.className = 'cell-wrapper';
                    
                    const cell = document.createElement('textarea');
                    cell.className = 'grid-input';
                    cell.id = `mcell-${i}-${j}`;
                    cell.dataset.gridId = i; cell.dataset.cellId = j;
                    cell.spellcheck = false;

                    if(i===4 && j===4) { cellWrapper.classList.add('main-goal'); cell.placeholder = 'í•µì‹¬\nëª©í‘œ'; }
                    else if(i===4) { cellWrapper.classList.add('sub-goal'); cell.placeholder = 'ì„¸ë¶€\nëª©í‘œ'; }
                    else if(j===4) { cellWrapper.classList.add('sub-goal'); cell.readOnly = true; cell.placeholder = 'ì„¸ë¶€\nëª©í‘œ'; } 
                    else { cell.placeholder = 'ê³„íš'; }
                    
                    cell.addEventListener('input', (e) => {
                        const val = e.target.value;
                        if(!allMandalartData[window.currentYear]) allMandalartData[window.currentYear] = {};
                        allMandalartData[window.currentYear][e.target.id] = val;
                        
                        // ì¤‘ì•™ -> ì™¸ê³½ ì—°ë™
                        if(i===4 && j!==4) {
                            const t = document.getElementById(`mcell-${j}-4`);
                            if(t) t.value = val;
                        }
                        saveToCloud();
                    });
                    
                    cellWrapper.appendChild(cell);
                    subGrid.appendChild(cellWrapper);
                }
                grid.appendChild(subGrid);
            }
        }

        window.switchTab = function(name) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            if (name === 'mandalart') {
                document.getElementById('bigstoneView').style.display = 'none';
                document.getElementById('mandalartView').classList.add('active');
                renderMandalart();
            } else {
                document.getElementById('mandalartView').classList.remove('active');
                document.getElementById('bigstoneView').style.display = 'block';
                window.currentMonth !== null ? showMonthDetail(window.currentMonth) : renderYearView();
            }
        };

        window.showAddForm = (t, c) => {
            const f = document.getElementById(`form-${t}-${c}`);
            f.innerHTML = `
                <input id="in-${t}-${c}" placeholder="ë‚´ìš© ì…ë ¥">
                <input type="date" id="date-${t}-${c}">
                <div style="text-align:right; margin-top:5px;">
                    <button class="btn-secondary" onclick="this.parentElement.parentElement.classList.remove('active')">ì·¨ì†Œ</button> 
                    <button style="background:#1a73e8;color:white;padding:6px 12px;border:none;border-radius:4px;cursor:pointer" onclick="addT('${t}','${c}')">ì €ì¥</button>
                </div>`;
            f.classList.add('active');
            document.getElementById(`in-${t}-${c}`).focus();
        };

        window.addT = (t, c) => {
            const txt = document.getElementById(`in-${t}-${c}`).value;
            if(!txt) return;
            const task = { text: txt, deadline: document.getElementById(`date-${t}-${c}`).value, completed: false };
            const d = allBigstoneData[window.currentYear];
            if(t==='bigstone') {
                if(!d.bigstones[window.currentMonth]) d.bigstones[window.currentMonth]={};
                if(!d.bigstones[window.currentMonth][c]) d.bigstones[window.currentMonth][c]=[];
                d.bigstones[window.currentMonth][c].push(task);
            } else {
                if(!d.todos[window.currentMonth]) d.todos[window.currentMonth]=[];
                d.todos[window.currentMonth].push(task);
            }
            saveToCloud();
            document.getElementById(`form-${t}-${c}`).classList.remove('active');
            t==='bigstone'?renderTasks(t, c):renderTasks(t, 'general');
        };

        window.toggleTask = (t, c, i) => {
            const d = allBigstoneData[window.currentYear];
            const list = t==='bigstone' ? d.bigstones[window.currentMonth][c] : d.todos[window.currentMonth];
            list[i].completed = !list[i].completed;
            saveToCloud();
            t==='bigstone'?renderTasks(t, c):renderTasks(t, 'general');
        };

        window.delTask = (t, c, i) => {
            if(!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            const d = allBigstoneData[window.currentYear];
            const list = t==='bigstone' ? d.bigstones[window.currentMonth][c] : d.todos[window.currentMonth];
            list.splice(i, 1);
            saveToCloud();
            t==='bigstone'?renderTasks(t, c):renderTasks(t, 'general');
        };

        window.exportData = () => {
            const blob = new Blob([JSON.stringify({bigstones:allBigstoneData, mandalarts:allMandalartData},null,2)], {type:'application/json'});
            const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`backup_${new Date().toISOString().slice(0,10)}.json`; a.click();
        };

        initYearSelect();
    </script>
</body>
</html>
